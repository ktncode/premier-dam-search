<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Premier DAMåº—èˆ—æ¤œç´¢</title>
    <style>
      body {
        font-family: "Hiragino Sans", "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN W3",
          "Hiragino Kaku Gothic ProN", "Arial", "ãƒ¡ã‚¤ãƒªã‚ª", "Meiryo", sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 3px solid #2196f3;
        padding-bottom: 10px;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      button:hover {
        background: #1976d2;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .progress {
        margin-bottom: 20px;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 5px;
        display: none;
      }

      .progress.show {
        display: block;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: #4caf50;
        width: 0%;
        transition: width 0.3s ease;
      }

      .results {
        margin-top: 20px;
      }

      .prefecture-section {
        margin-bottom: 30px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .prefecture-header {
        background: #f5f5f5;
        padding: 10px 15px;
        border-bottom: 1px solid #ddd;
        font-weight: bold;
      }

      .city-section {
        margin: 10px;
      }

      .city-header {
        background: #e3f2fd;
        padding: 8px 12px;
        border-radius: 3px;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .shop-item {
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 3px;
        padding: 10px;
        margin-bottom: 10px;
      }

      .shop-name {
        font-weight: bold;
        font-size: 16px;
        color: #1976d2;
        margin-bottom: 5px;
      }

      .shop-address {
        color: #666;
        margin-bottom: 3px;
      }

      .shop-phone {
        color: #666;
        margin-bottom: 5px;
      }

      .shop-machines {
        font-size: 12px;
        color: #4caf50;
      }

      .error {
        color: #f44336;
        background: #ffebee;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }

      .prefecture-selector {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .prefecture-selector h3 {
        margin: 0 0 10px 0;
        font-size: 16px;
      }

      .prefecture-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
      }

      .prefecture-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 13px;
      }

      .prefecture-item input[type="checkbox"] {
        margin: 0;
        transform: scale(0.9);
      }

      .selector-controls {
        margin-top: 10px;
        display: flex;
        gap: 10px;
      }

      .selector-controls button {
        font-size: 12px;
        padding: 5px 10px;
        background: #6c757d;
      }

      .selector-controls button:hover {
        background: #5a6268;
      }

      .status {
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 12px;
        margin-left: 10px;
      }

      .status.processing {
        background: #fff3e0;
        color: #ef6c00;
      }

      .status.completed {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .status.error {
        background: #ffebee;
        color: #c62828;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¤ Premier DAMåº—èˆ—æ¤œç´¢</h1>

      <div
        style="
          background: #e3f2fd;
          padding: 10px;
          border-radius: 5px;
          margin-bottom: 20px;
          font-size: 14px;
        "
      >
        <strong>ğŸ“‹ æ¤œç´¢æ¡ä»¶:</strong> Premier DAM (machine=03)
        ã‚’è¨­ç½®ã—ã¦ã„ã‚‹åº—èˆ—ã®ã¿ã‚’è¡¨ç¤ºã—ã¾ã™<br />
        <strong>ğŸŒ Express API:</strong> Node.js +
        Expressã‚µãƒ¼ãƒãƒ¼ã§ãƒ—ãƒ­ã‚­ã‚·å‡¦ç†<br />
        <strong>ğŸ”¤ æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°:</strong> Shift_JIS â†’ UTF-8 è‡ªå‹•å¤‰æ›å¯¾å¿œ
      </div>

      <div class="controls">
        <button id="start-all" onclick="startSearch()">æ¤œç´¢é–‹å§‹</button>
        <button id="stop-search" onclick="stopSearch()" disabled>
          æ¤œç´¢åœæ­¢
        </button>
        <button id="clear-results" onclick="clearResults()">çµæœã‚¯ãƒªã‚¢</button>
      </div>

      <div class="prefecture-selector">
        <h3>ğŸ—¾ æ¤œç´¢å¯¾è±¡éƒ½é“åºœçœŒ</h3>
        <div class="selector-controls">
          <button onclick="selectAllPrefectures()">å…¨é¸æŠ</button>
          <button onclick="deselectAllPrefectures()">å…¨è§£é™¤</button>
          <button onclick="selectRegion('kanto')">é–¢æ±</button>
          <button onclick="selectRegion('kansai')">é–¢è¥¿</button>
        </div>
        <div class="prefecture-grid" id="prefecture-grid">
          <!-- éƒ½é“åºœçœŒãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯JavaScriptã§å‹•çš„ç”Ÿæˆ -->
        </div>
      </div>

      <div class="progress" id="progress">
        <div>é€²æ—: <span id="progress-text">0/47éƒ½é“åºœçœŒ</span></div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <div class="results" id="results"></div>
    </div>

    <script>
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
      let isSearching = false;
      let shouldStop = false;
      let totalShops = 0;
      let abortController = null; // API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸­æ–­ç”¨

      // åœ°åŸŸåˆ¥éƒ½é“åºœçœŒã‚°ãƒ«ãƒ¼ãƒ—
      const regions = {
        kanto: ["08", "09", "10", "11", "12", "13", "14"], // èŒ¨åŸã€œç¥å¥ˆå·
        kansai: ["25", "26", "27", "28", "29", "30"], // æ»‹è³€ã€œå’Œæ­Œå±±
      };

      // éƒ½é“åºœçœŒãƒªã‚¹ãƒˆï¼ˆ1-47ï¼‰
      const prefectures = [
        { code: "01", name: "åŒ—æµ·é“" },
        { code: "02", name: "é’æ£®çœŒ" },
        { code: "03", name: "å²©æ‰‹çœŒ" },
        { code: "04", name: "å®®åŸçœŒ" },
        { code: "05", name: "ç§‹ç”°çœŒ" },
        { code: "06", name: "å±±å½¢çœŒ" },
        { code: "07", name: "ç¦å³¶çœŒ" },
        { code: "08", name: "èŒ¨åŸçœŒ" },
        { code: "09", name: "æ ƒæœ¨çœŒ" },
        { code: "10", name: "ç¾¤é¦¬çœŒ" },
        { code: "11", name: "åŸ¼ç‰çœŒ" },
        { code: "12", name: "åƒè‘‰çœŒ" },
        { code: "13", name: "æ±äº¬éƒ½" },
        { code: "14", name: "ç¥å¥ˆå·çœŒ" },
        { code: "15", name: "æ–°æ½ŸçœŒ" },
        { code: "16", name: "å¯Œå±±çœŒ" },
        { code: "17", name: "çŸ³å·çœŒ" },
        { code: "18", name: "ç¦äº•çœŒ" },
        { code: "19", name: "å±±æ¢¨çœŒ" },
        { code: "20", name: "é•·é‡çœŒ" },
        { code: "21", name: "å²é˜œçœŒ" },
        { code: "22", name: "é™å²¡çœŒ" },
        { code: "23", name: "æ„›çŸ¥çœŒ" },
        { code: "24", name: "ä¸‰é‡çœŒ" },
        { code: "25", name: "æ»‹è³€çœŒ" },
        { code: "26", name: "äº¬éƒ½åºœ" },
        { code: "27", name: "å¤§é˜ªåºœ" },
        { code: "28", name: "å…µåº«çœŒ" },
        { code: "29", name: "å¥ˆè‰¯çœŒ" },
        { code: "30", name: "å’Œæ­Œå±±çœŒ" },
        { code: "31", name: "é³¥å–çœŒ" },
        { code: "32", name: "å³¶æ ¹çœŒ" },
        { code: "33", name: "å²¡å±±çœŒ" },
        { code: "34", name: "åºƒå³¶çœŒ" },
        { code: "35", name: "å±±å£çœŒ" },
        { code: "36", name: "å¾³å³¶çœŒ" },
        { code: "37", name: "é¦™å·çœŒ" },
        { code: "38", name: "æ„›åª›çœŒ" },
        { code: "39", name: "é«˜çŸ¥çœŒ" },
        { code: "40", name: "ç¦å²¡çœŒ" },
        { code: "41", name: "ä½è³€çœŒ" },
        { code: "42", name: "é•·å´çœŒ" },
        { code: "43", name: "ç†Šæœ¬çœŒ" },
        { code: "44", name: "å¤§åˆ†çœŒ" },
        { code: "45", name: "å®®å´çœŒ" },
        { code: "46", name: "é¹¿å…å³¶çœŒ" },
        { code: "47", name: "æ²–ç¸„çœŒ" },
      ];

      // åˆæœŸåŒ–é–¢æ•°
      function initializePrefectureSelector() {
        const grid = document.getElementById("prefecture-grid");
        grid.innerHTML = "";

        prefectures.forEach((pref) => {
          const item = document.createElement("div");
          item.className = "prefecture-item";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `pref-${pref.code}`;
          checkbox.value = pref.code;
          checkbox.checked = true; // åˆæœŸã¯å…¨é¸æŠ

          const label = document.createElement("label");
          label.htmlFor = `pref-${pref.code}`;
          label.textContent = pref.name;

          item.appendChild(checkbox);
          item.appendChild(label);
          grid.appendChild(item);
        });
      }

      // å…¨é¸æŠ/å…¨è§£é™¤
      function selectAllPrefectures() {
        document
          .querySelectorAll('#prefecture-grid input[type="checkbox"]')
          .forEach((cb) => {
            cb.checked = true;
          });
      }

      function deselectAllPrefectures() {
        document
          .querySelectorAll('#prefecture-grid input[type="checkbox"]')
          .forEach((cb) => {
            cb.checked = false;
          });
      }

      // åœ°åŸŸé¸æŠ
      function selectRegion(regionName) {
        deselectAllPrefectures();
        const regionCodes = regions[regionName] || [];
        regionCodes.forEach((code) => {
          const checkbox = document.getElementById(`pref-${code}`);
          if (checkbox) checkbox.checked = true;
        });
      }

      // é¸æŠã•ã‚ŒãŸéƒ½é“åºœçœŒã‚’å–å¾—
      function getSelectedPrefectures() {
        const selected = [];
        document
          .querySelectorAll('#prefecture-grid input[type="checkbox"]:checked')
          .forEach((cb) => {
            const pref = prefectures.find((p) => p.code === cb.value);
            if (pref) selected.push(pref);
          });
        return selected;
      }

      // æ¤œç´¢é–‹å§‹
      async function startSearch() {
        if (isSearching) return;

        const selectedPrefectures = getSelectedPrefectures();
        if (selectedPrefectures.length === 0) {
          alert("æ¤œç´¢å¯¾è±¡ã®éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„");
          return;
        }

        isSearching = true;
        shouldStop = false;
        totalShops = 0;
        abortController = new AbortController(); // ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­æ–­ç”¨

        document.getElementById("start-all").disabled = true;
        document.getElementById("stop-search").disabled = false;
        document.getElementById("progress").classList.add("show");

        console.log(`ğŸš€ æ¤œç´¢é–‹å§‹: ${selectedPrefectures.length}éƒ½é“åºœçœŒã‚’å‡¦ç†`);

        for (let i = 0; i < selectedPrefectures.length; i++) {
          if (shouldStop) {
            console.log("ğŸ›‘ æ¤œç´¢ã‚’åœæ­¢ã—ã¾ã—ãŸ");
            break;
          }

          const pref = selectedPrefectures[i];
          await processPrefecture(pref, i + 1, selectedPrefectures.length);

          // é€²æ—æ›´æ–°
          updateProgress(i + 1, selectedPrefectures.length);

          // 1.5ç§’å¾…æ©Ÿï¼ˆåœæ­¢ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
          if (i < selectedPrefectures.length - 1) {
            for (let wait = 0; wait < 15; wait++) {
              if (shouldStop) break;
              await sleep(100);
            }
          }
        }

        finishSearch();
      }

      // éƒ½é“åºœçœŒå‡¦ç†
      async function processPrefecture(pref, index, total) {
        console.log(`ğŸ” ${pref.name} (${index}/${total}) å‡¦ç†é–‹å§‹`);

        // éƒ½é“åºœçœŒã‚»ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
        const prefSection = createPrefectureSection(pref.name, index, total);
        document.getElementById("results").appendChild(prefSection);

        try {
          // å¸‚åŒºç”ºæ‘ãƒªã‚¹ãƒˆå–å¾—
          const cities = await getCityList(pref.code);
          console.log(`ğŸ“ ${pref.name}: ${cities.length}å¸‚åŒºç”ºæ‘ã‚’ç™ºè¦‹`);

          if (cities.length === 0) {
            addError(prefSection, "å¸‚åŒºç”ºæ‘ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
            return;
          }

          // å„å¸‚åŒºç”ºæ‘ã‚’å‡¦ç†
          for (const city of cities) {
            if (shouldStop) {
              console.log(`â¹ï¸ æ¤œç´¢åœæ­¢: ${pref.name} ${city.name}`);
              break;
            }

            try {
              const shops = await processCity(pref.code, city.code, city.name);
              if (shops.length > 0) {
                addCitySection(prefSection, city.name, shops);
                totalShops += shops.length;
              }

              // åœæ­¢ãƒã‚§ãƒƒã‚¯ä»˜ãå¾…æ©Ÿ
              for (let wait = 0; wait < 8; wait++) {
                if (shouldStop) break;
                await sleep(100);
              }
            } catch (error) {
              console.error(`âŒ ${pref.name} ${city.name} ã‚¨ãƒ©ãƒ¼:`, error);
              addError(prefSection, `${city.name}: ${error.message}`);
            }
          }

          updatePrefectureStatus(prefSection, "completed");
        } catch (error) {
          console.error(`âŒ ${pref.name} ã‚¨ãƒ©ãƒ¼:`, error);
          addError(prefSection, error.message);
          updatePrefectureStatus(prefSection, "error");
        }
      }

      // å¸‚åŒºç”ºæ‘ãƒªã‚¹ãƒˆå–å¾—ï¼ˆExpress APIä½¿ç”¨ã€ä¸­æ–­å¯¾å¿œï¼‰
      async function getCityList(prefCode) {
        const targetUrl = `https://www.clubdam.com/shopsearch/?todofukenCode=${prefCode}&machine=03`;
        const proxyUrl = `/api/proxy?url=${encodeURIComponent(targetUrl)}`;
        console.log(`ğŸ“¡ å¸‚åŒºç”ºæ‘ãƒªã‚¹ãƒˆå–å¾—: ${targetUrl}`);

        const response = await fetch(proxyUrl, {
          signal: abortController?.signal,
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const html = await response.text();
        console.log(
          `ğŸ”¤ æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: è‡ªå‹•å¤‰æ›æ¸ˆã¿ (Shift_JIS -> UTF-8)`
        );

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        const cities = [];
        const cityLinks = doc.querySelectorAll('a[href*="?todofukenCode="]');

        cityLinks.forEach((link) => {
          const href = link.getAttribute("href");
          const match = href.match(/todofukenCode=(\d+)&cityCode=(\d+)/);

          if (match && match[1] === prefCode && match[2] !== "") {
            const cityCode = match[2];
            const cityName = link.textContent.trim();

            if (cityName && !cities.find((c) => c.code === cityCode)) {
              cities.push({
                code: cityCode,
                name: cityName,
              });
            }
          }
        });

        return cities;
      }

      // å¸‚åŒºç”ºæ‘ã®åº—èˆ—å‡¦ç†ï¼ˆExpress APIä½¿ç”¨ã€ä¸­æ–­å¯¾å¿œï¼‰
      async function processCity(prefCode, cityCode, cityName) {
        const targetUrl = `https://www.clubdam.com/shopsearch/?todofukenCode=${prefCode}&cityCode=${cityCode}&machine=03`;
        const proxyUrl = `/api/proxy?url=${encodeURIComponent(targetUrl)}`;
        console.log(`ğŸª åº—èˆ—æ¤œç´¢: ${cityName} - ${targetUrl}`);

        const response = await fetch(proxyUrl, {
          signal: abortController?.signal,
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const html = await response.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        const shops = [];
        const resultItems = doc.querySelectorAll("li.result-item");

        resultItems.forEach((item) => {
          try {
            const shop = parseShopItem(item);
            // Premier DAMã‚’æŒã¤åº—èˆ—ã®ã¿ã‚’è¿½åŠ 
            if (shop && shop.machines.premier) {
              shops.push(shop);
            }
          } catch (error) {
            console.error("åº—èˆ—ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", error);
          }
        });

        console.log(`âœ… ${cityName}: ${shops.length}ä»¶ã®åº—èˆ—ã‚’å–å¾—`);
        return shops;
      }

      // åº—èˆ—ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ‘ãƒ¼ã‚¹
      function parseShopItem(item) {
        const nameElement = item.querySelector("span.store-name, a.store-name");
        const addressElement = item.querySelector("div.store-address > span");
        const phoneElement = item.querySelector("div.store-tel > a");
        const mapElement = item.querySelector("div.store-address > a");

        if (!nameElement || !addressElement) {
          return null;
        }

        const name = nameElement.textContent.trim();
        const address = addressElement.textContent.trim();
        const phone = phoneElement ? phoneElement.textContent.trim() : "";

        // ç·¯åº¦çµŒåº¦ã®æŠ½å‡º
        let latitude = null,
          longitude = null;
        if (mapElement) {
          const href = mapElement.getAttribute("href");
          const mapMatch = href.match(/q=([0-9.-]+),([0-9.-]+)/);
          if (mapMatch) {
            latitude = parseFloat(mapMatch[1]);
            longitude = parseFloat(mapMatch[2]);
          }
        }

        // æ©Ÿç¨®æƒ…å ±ã®æŠ½å‡º
        const machines = {
          ai: false,
          studium: false,
          normal: false,
          premier: false,
        };

        const machineImages = item.querySelectorAll("li.machine-item > img");
        machineImages.forEach((img) => {
          const alt = img.getAttribute("alt");
          switch (alt) {
            case "LIVE DAM Ai":
              machines.ai = true;
              break;
            case "LIVE DAM STADIUM":
              machines.studium = true;
              break;
            case "LIVE DAM":
              machines.normal = true;
              break;
            case "PremierDAM":
              machines.premier = true;
              break;
          }
        });

        // æ©Ÿèƒ½æƒ…å ±ã®æŠ½å‡º
        const features = [];
        const featureElements = item.querySelectorAll("li.feature-item > span");
        featureElements.forEach((span) => {
          const text = span.textContent.trim();
          if (text) features.push(text);
        });

        return {
          name,
          address,
          phone,
          latitude,
          longitude,
          machines,
          features: features.join(", "),
        };
      }

      // UIä½œæˆãƒ»æ›´æ–°é–¢æ•°
      function createPrefectureSection(prefName, index, total = 47) {
        const section = document.createElement("div");
        section.className = "prefecture-section";
        section.innerHTML = `
          <div class="prefecture-header">
            ${prefName} (${index}/${total})
            <span class="status processing">å‡¦ç†ä¸­...</span>
          </div>
        `;
        return section;
      }

      function addCitySection(prefSection, cityName, shops) {
        const citySection = document.createElement("div");
        citySection.className = "city-section";

        const cityHeader = document.createElement("div");
        cityHeader.className = "city-header";
        cityHeader.textContent = `${cityName} (${shops.length}ä»¶)`;
        citySection.appendChild(cityHeader);

        shops.forEach((shop) => {
          const shopItem = document.createElement("div");
          shopItem.className = "shop-item";

          // Premier DAMã®ã¿è¡¨ç¤ºï¼ˆä»–ã®æ©Ÿç¨®ã‚‚æŒã£ã¦ã„ã‚‹å ´åˆã‚‚å«ã‚€ï¼‰
          const machineTypes = ["Premier DAM"];
          if (shop.machines.ai) machineTypes.push("LIVE DAM Ai");
          if (shop.machines.studium) machineTypes.push("STADIUM");
          if (shop.machines.normal) machineTypes.push("LIVE DAM");

          shopItem.innerHTML = `
            <div class="shop-name">${escapeHtml(shop.name)}</div>
            <div class="shop-address">ğŸ“ ${escapeHtml(shop.address)}</div>
            ${
              shop.phone
                ? `<div class="shop-phone">ğŸ“ ${escapeHtml(shop.phone)}</div>`
                : ""
            }
            <div class="shop-machines">ğŸ¤ ${machineTypes.join(", ")}</div>
            ${
              shop.features
                ? `<div class="shop-machines">âœ¨ ${escapeHtml(
                    shop.features
                  )}</div>`
                : ""
            }
          `;

          citySection.appendChild(shopItem);
        });

        prefSection.appendChild(citySection);
      }

      function addError(prefSection, message) {
        const error = document.createElement("div");
        error.className = "error";
        error.textContent = message;
        prefSection.appendChild(error);
      }

      function updatePrefectureStatus(prefSection, status) {
        const statusElement = prefSection.querySelector(".status");
        statusElement.className = `status ${status}`;

        if (status === "completed") {
          statusElement.textContent = "å®Œäº†";
        } else if (status === "error") {
          statusElement.textContent = "ã‚¨ãƒ©ãƒ¼";
        }
      }

      function updateProgress(current, total) {
        const progressText = document.getElementById("progress-text");
        const progressFill = document.getElementById("progress-fill");

        progressText.textContent = `${current}/${total}éƒ½é“åºœçœŒ (ç·åº—èˆ—æ•°: ${totalShops}ä»¶)`;
        progressFill.style.width = `${(current / total) * 100}%`;
      }

      // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      function stopSearch() {
        console.log("ğŸ›‘ æ¤œç´¢åœæ­¢è¦æ±‚");
        shouldStop = true;

        // é€²è¡Œä¸­ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å³åº§ã«ä¸­æ–­
        if (abortController) {
          abortController.abort();
          console.log("âš¡ APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸­æ–­ã—ã¾ã—ãŸ");
        }

        finishSearch();
      }

      function finishSearch() {
        isSearching = false;
        shouldStop = false;

        document.getElementById("start-all").disabled = false;
        document.getElementById("stop-search").disabled = true;

        console.log(`ğŸ‰ æ¤œç´¢å®Œäº†: ç·åº—èˆ—æ•° ${totalShops}ä»¶`);
      }

      function clearResults() {
        document.getElementById("results").innerHTML = "";
        document.getElementById("progress").classList.remove("show");
        totalShops = 0;
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚
      document.addEventListener("DOMContentLoaded", function () {
        console.log(`ğŸŒ Premier DAMåº—èˆ—æ¤œç´¢ èª­ã¿è¾¼ã¿å®Œäº†`);
        console.log("âœ… Premier DAM (machine=03) ã®ã¿ã‚’æ¤œç´¢ãƒ»è¡¨ç¤º");
        console.log("ğŸ”¤ æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: Shift_JIS -> UTF-8 è‡ªå‹•å¤‰æ›");
        console.log("ğŸš€ Express + Node.js ãƒ™ãƒ¼ã‚¹ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³");

        // éƒ½é“åºœçœŒãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
        initializePrefectureSelector();
      });
    </script>
  </body>
</html>
